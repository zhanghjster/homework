#### 简介

顾名思义，APM是对应用性能进行监控的工具。它可以帮助我们理解应用系统的性能状态，快速定位问题根因，对重要性能指标进行告警。在微服务日益流行的今天，它为开发、运维人员对复杂分布式系统的性能管理提供更多手段

单体应用在定位性能问题时，通常是将执行流程分片并记录每个分片的执行时间。在微服务环境下亦是如此，将耗时以对不同依赖系统的调用进行分片。

#### Dapper

由谷歌开发的在生产环境下的分布式应用性能追踪系统

##### 面临问题

以用户的一次搜索为例

* 一个搜索要调用各种子系统
* 用户对搜索耗时非常敏感，任何子系统的低效都会影响最终搜索耗时

如果出现耗时异常，工程师需要定位由哪些服务造成的，但面临如下问题

* 工程师可能无法准确定位搜索使用了哪些服务
* 工程师无法对所有服务了如指掌

Dapper需要全量部署、持续监控， 任何服务或时间段没有被监控都会让人对整个系统的信任产生质疑

##### 设计目标

1. 性能消耗低
2. 代码侵入性小
3. 分布式部署
4. 提供数据分析
   * 速度要快
   * 维度要多

##### 设计原理

1. 跟踪树

2. Span

   span最小追踪单元，一次链路调用一个span，由ID、父ID、Annotation、TraceId组成

3. TraceId

   树结构Span的集合，表示一次完整的追踪

4. Annotation

   记录特定事件的相关信息，比如时间

#### APM 选型

可选

> 1. ZipKin
>
>    facebook开源用于追踪微服务架构的延迟为题，包括收集、存储、搜索、展示
>
> 2. PinPoint
>
>    韩国人开发分布式追踪组件
>
> 3. Skywalking
>
>    国人开发用于Java分布式应用业务运行状态追踪、告警、分析

##### 对比项

* 探针性能

  吞吐量、cpu、内存损耗

  不同并发下对同一应用程序相同span下并发下对服务的QPS、响应时间、cpu、内存的使用情况进行对比

* 中央收集器

  水平扩展能力，agent和收集器使用grpc或thrif等协议通信

* 调用链全链路分析能力

  代码级别可见性、定位失败点瓶颈

  1. 展示调用树
  2. 每一级别的耗时

* 开发透明，容易开关

* 调用链拓扑

  自动检测拓扑，清除系统架构

* 社区支持

将对比指标分中高低评分确定选型







